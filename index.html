<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>P2P GLOBAL - SEM ERRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #00ff88; --bg: #050505; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: #fff; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: #111; border: 2px solid #222; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        
        textarea { width: 100%; height: 120px; background: #000; color: var(--neon); border: 1px solid #444; padding: 10px; border-radius: 8px; font-family: monospace; }
        button { width: 100%; padding: 16px; background: var(--neon); color: #000; border: none; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        
        .preview-box { background: #fff; height: 320px; width: 100%; border-radius: 10px; margin-top: 10px; border: 4px solid #222; overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; }
        
        #status { font-size: 10px; color: var(--neon); text-align: center; margin-bottom: 10px; text-transform: uppercase; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup" class="card">
        <h2 style="text-align:center; color:var(--neon)">P2P AUTO-CONECT</h2>
        <div id="status">Iniciando Motor...</div>
        <input id="userName" placeholder="TEU NOME" style="width:100%; padding:12px; background:#000; border:1px solid #444; color:#fff;">
        <button onclick="entrar()">ENTRAR NA REDE AGORA</button>
    </div>

    <div id="app" class="hidden">
        <div class="card">
            <textarea id="editor" placeholder="<h1>CÓDIGO AQUI</h1>"></textarea>
            <button onclick="enviar()">PUBLICAR PARA TODOS</button>
        </div>
        <div id="feed"></div>
    </div>
</div>

<script>
    let peer, conexoes = [], meuNome;
    // IDs de 1 a 10 para criar uma malha de conexão automática
    const SALAS_IDS = ["P2P-MASTER-1", "P2P-MASTER-2", "P2P-MASTER-3"]; 

    function entrar() {
        meuNome = document.getElementById('userName').value || "User";
        
        // Tenta pegar um dos IDs mestres. Se falhar, cria um aleatório e tenta conectar neles.
        conectarRecursivo(0);
    }

    function conectarRecursivo(index) {
        if (index >= SALAS_IDS.length) {
            // Se não conseguiu ser um dos IDs mestres, entra como cliente
            peer = new Peer();
            peer.on('open', (id) => {
                document.getElementById('status').innerText = "CONECTADO COMO CLIENTE";
                SALAS_IDS.forEach(target => conectarAoPeer(target));
                abrirApp();
            });
            return;
        }

        // Tenta assumir um ID Master
        peer = new Peer(SALAS_IDS[index]);

        peer.on('open', () => {
            document.getElementById('status').innerText = "VOCÊ É O HOST " + (index + 1);
            abrirApp();
            // Tenta conectar nos outros mestres para sincronizar
            SALAS_IDS.forEach(target => {
                if(target !== SALAS_IDS[index]) conectarAoPeer(target);
            });
        });

        peer.on('error', (err) => {
            if (err.type === 'unavailable-id') {
                conectarRecursivo(index + 1); // Tenta o próximo ID mestre
            }
        });

        peer.on('connection', (c) => {
            conexoes.push(c);
            setupConn(c);
        });
    }

    function conectarAoPeer(idAlvo) {
        let c = peer.connect(idAlvo);
        c.on('open', () => {
            conexoes.push(c);
            setupConn(c);
        });
    }

    function setupConn(c) {
        c.on('data', (data) => renderizar(data));
    }

    function abrirApp() {
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
    }

    function enviar() {
        const codigo = document.getElementById('editor').value;
        if (!codigo) return;
        const pacote = { id: Date.now(), autor: meuNome, html: codigo };
        renderizar(pacote);
        conexoes.forEach(c => { if (c.open) c.send(pacote); });
        document.getElementById('editor').value = "";
    }

    function renderizar(data) {
        if (document.getElementById('post-' + data.id)) return;
        const feed = document.getElementById('feed');
        const div = document.createElement('div');
        div.id = 'post-' + data.id;
        div.className = 'card';
        div.innerHTML = `<small style="color:var(--neon)">@${data.autor}</small>
                         <div class="preview-box"><iframe id="frame-${data.id}"></iframe></div>`;
        feed.prepend(div);

        setTimeout(() => {
            const frame = document.getElementById('frame-' + data.id);
            const doc = frame.contentWindow.document;
            doc.open(); doc.write(data.html); doc.close();
        }, 150);
    }
</script>
</body>
</html>
